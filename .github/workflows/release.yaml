name: Deploy new version of application

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - develop

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Check repo
        uses: actions/checkout@v2

      - name: Set image name variable
        run: |
          timestamp=$(date +%Y%m%d%H%M%S)
          version=$(echo "$timestamp" | sed -E 's/(.*)/v\1/')
          echo "::set-env name=IMAGE_NAME::cherryswap/v:$version"

      - name: Prefix image name
        run: |
          prefix="dev-"
          if [ "$GITHUB_REF" == "refs/heads/master" ]; then
            prefix="prod-"
          fi
          echo "::set-env name=IMAGE_NAME::$prefix$VERSION"

      - name: Build images
        run: docker build -t $IMAGE_NAME .

      - name: Save image to tar
        run: docker save $IMAGE_NAME -o "${IMAGE_NAME}.tar"

      - name: Upload tar file
        uses: actions/upload-artifact@v2
        with:
          name: '${IMAGE_NAME}.tar'
          path: '${IMAGE_NAME}.tar'

      - name: Connect to server via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}

      - name: Download tar file
        uses: actions/download-artifact@v2
        with:
          name: '${IMAGE_NAME}.tar'
          path: ~/images/"${IMAGE_NAME}.tar"
